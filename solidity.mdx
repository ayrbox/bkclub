# Two type of accounts

1. Externally Owned Account
2. Contract Accounts

---


# Externally Owned Account (EOA)

- External of Ethereum
- Controlled by person/user via wallet
- Simple and no code associated with it
- Controlled(?) by transactions created and crypotographycally signed 
---

# Contract Account

- Do not have private keys
- Code associated
- Do not have keys (but controlled by predetermined code

---

# Smart Contract

Coined by Nick Szabo in 1990

“a set of promises, specified in digital form, including protocols within which the parties perform on the other promises.”

After introduction of Bitcoin in 2019 the concept evolved.

Throughout the book, "Smart Contract" refers to "Immutable computer programs" that run determiniscally running in context of EVM within **Ethereum Network Protocol**.
---
# Smart contract 
simple computer program and is not *Smart* nor *Legal*. (Author stated its misnomer)
---
# Immutable

Once deployed the code can not change (Immutable)
---
# Deterministic

Outcome of execution is same given context is same.
---
# EVM Context

Limitation of smart contract. Access to only own state, context of transaction(?), and some information about most recent blocks.
---

# Decentralized world computer

EVM runs as local instance on every Ethereum node. All instances of the EVM operate on the same initial state and produce the same final state and operates as 'whole computer'.

---

# Lift Cycle of Smart Contract 

How to write smart contract

---

# Written in High Level Langauge

https://github.com/appliedblockchain/launchpad/blob/master/contracts/contracts/HelloWorld.sol

---

# Compiled to byte-code (low level)

LaunchPad (HelloWorldContract)

     0x608060405234801561001057600080fd5b506040805190810160405280600b81526020017f48656c6c6f20576f726c640000000000000000000000000000000000000000008152506000908051906020019061005c929190610062565b50610107565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100a357805160ff19168380011785556100d1565b828001600101855582156100d1579182015b828111156100d05782518255916020019190600101906100b5565b5b5090506100de91906100e2565b5090565b61010491905b808211156101005760008160009055506001016100e8565b5090565b90565b61040b806101166000396000f3fe608060405260043610610045576000357c0100000000000000000000000000000000000000000000000000000000900480620e5c801461004a578063a7ef432914610073575b600080fd5b34801561005657600080fd5b50610071600480360361006c9190810190610281565b61009e565b005b34801561007f57600080fd5b506100886100e4565b60405161009591906102f8565b60405180910390f35b80600090805190602001906100b4929190610186565b507f5eef3c2a81e36faced0bde4f32716563decc323e1d73057f43d12fab649b7b6c60405160405180910390a150565b606060008054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561017c5780601f106101515761010080835404028352916020019161017c565b820191906000526020600020905b81548152906001019060200180831161015f57829003601f168201915b5050505050905090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106101c757805160ff19168380011785556101f5565b828001600101855582156101f5579182015b828111156101f45782518255916020019190600101906101d9565b5b5090506102029190610206565b5090565b61022891905b8082111561022457600081600090555060010161020c565b5090565b90565b600082601f830112151561023e57600080fd5b813561025161024c82610347565b61031a565b9150808252602083016020830185838301111561026d57600080fd5b61027883828461037e565b50505092915050565b60006020828403121561029357600080fd5b600082013567ffffffffffffffff8111156102ad57600080fd5b6102b98482850161022b565b91505092915050565b60006102cd82610373565b8084526102e181602086016020860161038d565b6102ea816103c0565b602085010191505092915050565b6000602082019050818103600083015261031281846102c2565b905092915050565b6000604051905081810181811067ffffffffffffffff8211171561033d57600080fd5b8060405250919050565b600067ffffffffffffffff82111561035e57600080fd5b601f19601f8301169050602081019050919050565b600081519050919050565b82818337600083830152505050565b60005b838110156103ab578082015181840152602081019050610390565b838111156103ba576000848401525b50505050565b6000601f19601f830116905091905056fea265627a7a7230582050148853d644c280b35e7b9bbfb9c590c78f4cf24a33ec8c6a96f52bfb906ea66c6578706572696d656e74616cf50037

---

# Deployed on Ethereum 

Special Transaction *Contract creation transaction*. The contract address starts `0x0` which is derived from the creation transaction as function of originating account and nonce(:question:). 

---

Contract address can be used in transaction as receipt, sending funds to contract, or calling functions.
---
The creator gets same privilage as everybody else (depends on code written).
---
Contract code only runs (invoked) by transactions. Transactions are in-turn initiated by EOA. It never runs in background or automatically. The execution does not run in parallel (:confused:)
---

Deployed contract can not be modified but can be deleted (including internal state).  

SLEFDESTUCT opcode is invoked that has "negative gas" :question: *where is gas refined* **guessing its creator**

The funtionality is only available if it is programmed by author else can never be deleted.

Transaction history however remains in blockchain.

--- 

# Transaction are atomic.

Changes are recoreded only if all execution terminates successfully (meaning no error and reach the end).

Rolls back if fails.

Failed transactions are recoreded but ether spend on gas is deducted.

---

# Ethereum High Level Language

It is virtual machine (similar to CPU x86-64)
Bytecode are executed by EVM
Bytecode can be written in bytecode but its not friendly. *even solidity is not very friendly* :grinning: in compare to other lanague

---

Instead, High-level language is used that is compiled to bytecode.

--- 

Any high-level langauge be converted to byte code, but would difficult because smart contract run in more constraint and minimalistic environment. So Ethereuem specific language are created.

---

There are few languages for writing smart contract in ethereum. (Solidity, Vyper)

---

# General Language Type

---

# Declarative (e.g Haskel, SQL)

Only logic but no flow
No variables
Declarative language is easier to know how program will behave (no side effects)

--- 

# Imperlative (e.g C++, Java)

Logic and flow
Can be used to write declarative program
Used by many developers but unlikely to bug free
---
# Hybrid
Javascript, Python, Lisp

---

Smart Contract bug cost money :money_mouth_face: :pound:

---


So should not contain any unindented sideeffect.

And declarative paradigm is go to but widely popular langauge is solidity which is a imperlative language :confused:

---


### LLL 

- Declarative
- Lisp-**likewithout iterative flows (loops)**

---


### Serpant

- Imperlative
- Python like

---


### Solidity

- Imperlative
- Inspired by Javascript, C++, Java
- Most Popular

---


### Vyper

- New
- Python like
- Close to pure-functional

---


### Bamboo

- New
- Erlang like
- without iterative flows (loops)
- Intended to reduce side effects

---


# Solidity

Created by Dr. Gavin Wood (Co-author).

Developed by Christian Reitiwessner and then also by Alex Beregszaszi, Liana Husikyan, Yoichi Hirai, and several former Ethereum core contributors.

Use by other blockchain too. 

Now maintained as separte project.


---



## Solidity Version

Follows semantic versioning. 

*MAJOR.MINOR.PATCH*

Current Version: 0.5.2 https://github.com/ethereum/solidity/releases


---



### Install compiler - solc

Example on book Debian based

```
$ sudo add-apt-repository ppa:ethereum/ethereum
$ sudo apt update
$ sudo apt install solc
```

---


https://solidity.readthedocs.io/en/v0.4.24/installing-solidity.html

Actually depends on operating system

For mac brew can be used

I am currenlty using docker version :sunglasses:

Text Editor / IDE

VSCode, Atom, Emac. Vim

---




# Ethereum Contract ABI

Stands for Application Binary Interface

Defines interface between two program.

---


Example mobile app know what to send and what to expect thus encode and decodes data.

ABI is JSON array that describes functions and events. Produced by compiler (solo)

Functions : `type`, `name`, `inputs`, `outputs`, `constant`, and `payable`.

Events: type`, `name`, `inputs`, and `anonymous

---


```
$ solc --abi Faucet.sol
======= Faucet.sol:Faucet =======
Contract JSON ABI
[{"constant":false,"inputs":[{"name":"withdraw_amount","type":"uint256"}], \
"name":"withdraw","outputs":[],"payable":false,"stateMutability":"nonpayable", \
"type":"function"},{"payable":true,"stateMutability":"payable", \
"type":"fallback"}]
```


---



# Compiler and Language

Compiler version should match langauge version otherwise it show errors and warning.

The language is on constant change so lot of breaking change can be expected.

Compiler is able to read the version and produce error, warning and suggestions.

---


# Solidity Language

---


## Data Types

- Boolean (bool)

  Boolean value, true or false, with logical operators ! (not), && (and), || (or), == (equal), and != (not equal).

---


- Integer (int, uint)

  Signed (int) and unsigned (uint) integers, declared in increments of 8 bits from int8 to uint256. Without a size suffix, 256-bit quantities are used, to match the word size of the EVM.

---


- Fixed point (fixed, ufixed)

  Fixed-point numbers, declared with (`u`)`fixed*M*x*N*` where *M* is the size in bits (increments of 8 up to 256) and *N* is the number of decimals after the point (up to 18); e.g., ufixed32x2.

---


- Address

  A 20-byte Ethereum address. The address object has many helpful member functions, the main ones being balance (returns the account balance) and `transfer` (transfers ether to the account).

---


- Byte array (fixed)

  Fixed-size arrays of bytes, declared with bytes1 up to bytes32.

---


- Byte array (dynamic)

  Variable-sized arrays of bytes, declared with bytes or string.

- Enum

  User-defined type for enumerating discrete values: enum NAME {LABEL1, LABEL 2, ...}.

- Arrays

---


  An array of any type, either fixed or dynamic: uint32[][5] is a fixed-size array of five dynamic arrays of unsigned integers.

- Struct

  User-defined data containers for grouping variables: `struct NAME {TYPE1 VARIABLE1; TYPE2 VARIABLE2; ...}`.

- Mapping

  Hash lookup tables for *key* => *value* pairs: mapping(KEY_TYPE => VALUE_TYPE) NAME.

In addition to these data types, Solidity also offers a variety of value literals that can be used to calculate different units:

---


- Time units

  The units seconds, minutes, hours, and days can be used as suffixes, converting to multiples of the base unit seconds.

- Ether units

  The units wei, finney, szabo, and ether can be used as suffixes, converting to multiples of the base unit wei.

---


## Global Variables and Functions

### Transaction/Message Context

- msg.sender
- msg.value
- msg.gas - This was deprecated in Solidity v0.4.21
- msg.data
- msg.sig

---


### Transaction Context

- tx.gasprice
- tx.origin

---


### Block Context

- block.blockhash(__blockNumber__)
- block.coinbase
- block.difficulty
- block.gaslimit
- block.number
- block.timestamp

---


### Address Object

- address.balance
- address.transfer(__amount__)
- address.send(__amount__)
- address.call(__payload__)
- address.callcode(__payload__)
- address.delegatecall()

---


##### Built-in functions

- addmod, mulmod - For example, addmod(x,y,k) calculates (x + y) % k.
- keccak256, sha256, sha3, ripemd160
- ecrecover
- selfdestrunct(__recipient_address__)
- this

---


### Contract Definition

- interface
- library

---


### Functions

- FunctionName
- *parameters*

Visibility (invokability)

---


- public
- external
- internal
- private

---


Behaviour

- constant or view
- pure
- payable

---


## Contract - Contructor and Destructor

```js
pragma solidity ^0.4.22;

contract Faucet {
	address owner;
	
	constructor() {
		owner = msg.sender;
	}
	
	modifier onlyOwner {
        require(msg.sender == owner);
        _;
    }
    
	function destroy() public onlyOwner {
        require(msg.sender == owner);
        selfdestruct(owner);
    }
}
```

---


## Contract Inheritance

```javascript
contract Dog is Animal {
  ...
}

// multiple inheriance
contract Lion is Animal, Cat {
  ...
}
```

---


Example:

```javascript
contract owned {
	address owner;
	// Contract constructor: set owner
	constructor() {
		owner = msg.sender;
	}
	// Access control modifier
	modifier onlyOwner {
	    require(msg.sender == owner);
	    _;
	}
}

contract mortal is owned {
	// Contract destructor
	function destroy() public onlyOwner {
		selfdestruct(owner);
	}
}

---


contract Faucet is mortal {
    // Give out ether to anyone who asks
    function withdraw(uint withdraw_amount) public {
        // Limit withdrawal amount
        require(withdraw_amount <= 0.1 ether);
        // Send the amount to the address that requested it
        msg.sender.transfer(withdraw_amount);
    }
    // Accept any incoming amount
    function () public payable {}
}
```

---


## Error Handling

---


#### assert, require, revert

- throw is deprecated
- All state are reverted when error occurs

```java
require(msg.sender == owner);
//  v0.4.22
require(msg.sender == owner, "Only the contract owner can call this function");

require(this.balance >= withdraw_amount,
	"Insufficient balance in faucet for withdrawal request");
msg.sender.transfer(withdraw_amount);
```

---


## Events

- *Transaction receipt* is generated for all.

- Logs entries to defined events

- Web3.js library provide data structure to contains transactions logs

---


```js
contract Faucet is mortal {
	event Withdrawal(address indexed to, uint amount);
	event Deposit(address indexed from, uint amount);

	// Give out ether to anyone who asks
    function withdraw(uint withdraw_amount) public {
        [...]
        msg.sender.transfer(withdraw_amount);
        emit Withdrawal(msg.sender, withdraw_amount);
    }
    // Accept any incoming amount
    function () public payable {
        emit Deposit(msg.sender, msg.value);
    }
}
```


---



## Truffle

It is set of tool to develop dapp application. https://www.truffleframework.com/

---


```bash
$ truffle develop
truffle(develop)> compile
truffle(develop)> migrate
Using network 'develop'.

Running migration: 1_initial_migration.js
  Deploying Migrations...
  ... 0xb77ceae7c3f5afb7fbe3a6c5974d352aa844f53f955ee7d707ef6f3f8e6b4e61
  Migrations: 0x8cdaf0cd259887258bc13a92c0a6da92698644c0
Saving successful migration to network...
  ... 0xd7bc86d31bee32fa3988f1c1eabce403a1b5d570340a3a9cdba53a472ee8c956
Saving artifacts...
Running migration: 2_deploy_contracts.js
  Deploying Faucet...
  ... 0xfa850d754314c3fb83f43ca1fa6ee20bc9652d891c00a2f63fd43ab5bfb0d781
  Faucet: 0x345ca3e014aaf5dca488057592ee47305d9b3e10
Saving successful migration to network...
  ... 0xf36163615f41ef7ed8f4a8f192149a0bf633fe1a2398ce001bf44c43dc7bdda0
Saving artifacts...

truffle(develop)> Faucet.deployed().then(i => {FaucetDeployed = i})
truffle(develop)> FaucetDeployed.send(web3.toWei(1, "ether")).then(res => \
                  { console.log(res.logs[0].event, res.logs[0].args) })
Deposit { from: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  amount: BigNumber { s: 1, e: 18, c: [ 10000 ] } }
truffle(develop)> FaucetDeployed.withdraw(web3.toWei(0.1, "ether")).then(res => \
                  { console.log(res.logs[0].event, res.logs[0].args) })
Withdrawal { to: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  amount: BigNumber { s: 1, e: 17, c: [ 1000 ] } }
```

---


## Calling other Contracts

```js
// Creating a new instance
import "Faucet.sol";
contract Token is mortal {
	Faucet _faucet;
	constructor() {
		_faucet = (new Faucet).value(0.5 ether)();
	}
	function destroy() ownerOnly {
		_faucet.destroy();
	}
}

// Addressing an existing instance

import "Faucet.sol";
contract Token is mortal {

	Faucet _faucet;

	constructor(address _f) {
		_faucet = Faucet(_f);
		_faucet.withdraw(0.1 ether)
	}
}

---


// Raw call, delegatecall without error handling
contract Token is mortal {
	constructor(address _faucet) {
		_faucet.call("withdraw", 0.1 ether);
	}
}
// with error handle
contract Token is mortal {
	constructor(address _faucet) {
		if !(_faucet.call("withdraw", 0.1 ether)) {
			revert("Withdrawal from faucet failed");
		}
	}
}
```

---






# Gas Considerations

---


#### Avoid Dynamically Sized Arrays

---


#### Avoid Calls to Other Contracts

---


#### Estimating Gas Cost

---


```js
var contract = web3.eth.contract(abi).at(address);
// unit of gas required to call function
var gasEstimate = contract.myAweSomeMethod.estimateGas(arg1, arg2,
    {from: account});
var gasPrice = web3.eth.getGasPrice();

// total ether cost
var gasCostInEther = web3.fromWei((gasEstimate * gasPrice), 'ether');
```



---


# Questions

---
