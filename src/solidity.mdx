export { default as theme } from './theme.js'
import { Head, Image, Notes, Appear } from 'mdx-deck'
import { Invert, Split, FullScreenCode, Horizontal} from 'mdx-deck/layouts'
import Splash from './splash.js'
import CodeSlate from './CodeSlate'
import { CodeSurfer } from 'mdx-deck-code-surfer'

<Head>
  <title>Solidity Language</title>
</Head>

export default Splash

# **Solidity**

**Chapter 7**  
**MASTERING ETHEREUM**  

*Jan 2019*
---
# Two type of accounts
1. Externally Owned Account
2. Contract Accounts
---
# Externally Owned Account (EOA)

- External of Ethereum
- Controlled by person/user via wallet
- Simple and no code associated with it
- Controlled(?) by transactions created and crypotographycally signed 
---
# Contract Account

- Do not have private keys
- Code associated
- Do not have keys (but controlled by predetermined code

---
# Smart Contract

Coined by Nick Szabo in 1990
```
“a set of promises, specified in digital form, including protocols within which the parties perform on the other promises.”

After introduction of Bitcoin in 2019 the concept evolved.

Throughout the book, "Smart Contract" refers to "Immutable computer programs" that run determiniscally running in context of EVM within **Ethereum Network Protocol**.
---
# Smart contract 
simple computer program and is not *Smart* nor *Legal*. (Author stated its misnomer)
---
# Immutable

Once deployed the code can not change (Immutable)
---
# Deterministic

Outcome of execution is same given context is same.
---
# EVM Context

Limitation of smart contract. Access to only own state, context of transaction(?), and some information about most recent blocks.
---

# Decentralized world computer

EVM runs as local instance on every Ethereum node. All instances of the EVM operate on the same initial state and produce the same final state and operates as 'whole computer'.

---

# Lift Cycle of Smart Contract 

How to write smart contract

---
export default CodeSlate

<CodeSurfer
  code={require('raw-loader!./snippets/1.helloWorld.sol')}
  title="Written in High Level Language"
  dark={true}
  showNumbers
  steps={[
    { lines: [], notes: "Source: https://github.com/appliedblockchain/launchpad/blob/master/contracts/contracts/HelloWorld.sol"}, 
    { lines: [1], notes: "pragma solidity version number" },
    { lines: [4, 23], notes: "Contract block" },
    { range: [9, 11], notes: "Constructor" },
    { ranges: [[13, 18], [20, 22]], notes: "function blocks" },
    { lines: [5], notes: "storage variable" },
    { lines: [7, 17], notes: "Contract Events" },
    { tokens: { 13: [8], 20: [7] }, notes: "Function visibility" },
  ]}
/>
---
<CodeSurfer
  code={`0x608060405234801561001057600080fd5b506040805190810160405280600b81526020017f48656c6c6f20576f726c6400
00000000000000000000000000000000000000008152506000908051906020019061005c929190610062565b50610107565b
828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100a3578051
k60ff19168380011785556100d1565b828001600101855582156100d1579182015b828111156100d05782518255916020010
9190600101906100b5565b5b5090506100de91906100e2565b5090565b61010491905b808211156101005760008160009055
506001016100e8565b5090565b90565b61040b806101166000396000f3fe608060405260043610610045576000357c010000
0000000000000000000000000000000000000000000000000000900480620e5c801461004a578063a7ef432914610073575b
600080fd5b34801561005657600080fd5b50610071600480360361006c9190810190610281565b61009e565b005b34801561
007f57600080fd5b506100886100e4565b60405161009591906102f8565b60405180910390f35b8060009080519060200190
6100b4929190610186565b507f5eef3c2a81e36faced0bde4f32716563decc323e1d73057f43d12fab649b7b6c6040516040
5180910390a150565b606060008054600181600116156101000203166002900480601f016020809104026020016040519081
01604052809291908181526020018280546001816001161561010002031660029004801561017c5780601f10610151576101
0080835404028352916020019161017c565b820191906000526020600020905b81548152906001019060200180831161015f
57829003601f168201915b5050505050905090565b8280546001816001161561010002031660029004906000526020600020
90601f016020900481019282601f106101c757805160ff19168380011785556101f5565b828001600101855582156101f557
9182015b828111156101f45782518255916020019190600101906101d9565b5b5090506102029190610206565b5090565b61
022891905b8082111561022457600081600090555060010161020c565b5090565b90565b600082601f830112151561023e57
600080fd5b813561025161024c82610347565b61031a565b9150808252602083016020830185838301111561026d57600080
fd5b61027883828461037e565b50505092915050565b60006020828403121561029357600080fd5b600082013567ffffffff
ffffffff8111156102ad57600080fd5b6102b98482850161022b565b91505092915050565b60006102cd82610373565b8084
526102e181602086016020860161038d565b6102ea816103c0565b602085010191505092915050565b600060208201905081
8103600083015261031281846102c2565b905092915050565b6000604051905081810181811067ffffffffffffffff821117
1561033d57600080fd5b8060405250919050565b600067ffffffffffffffff82111561035e57600080fd5b601f19601f8301
169050602081019050919050565b600081519050919050565b82818337600083830152505050565b60005b838110156103ab
578082015181840152602081019050610390565b838111156103ba576000848401525b50505050565b6000601f19601f8301
16905091905056fea265627a7a7230582050148853d644c280b35e7b9bbfb9c590c78f4cf24a33ec8c6a96f52bfb906ea66c
6578706572696d656e74616cf50037`}
  lang="hex"
  title="Compiled to byte-code (low level)"
  notes="LaunchPad (HelloWorldContract)" 
/>
---

# Deployed on Ethereum 

Special Transaction *Contract creation transaction*. The contract address starts `0x0` which is derived from the creation transaction as function of originating account and nonce(:question:). 

---

Contract address can be used in transaction as receipt, sending funds to contract, or calling functions.
---
The creator gets same privilage as everybody else (depends on code written).
---
Contract code only runs (invoked) by transactions. Transactions are in-turn initiated by EOA. It never runs in background or automatically. The execution does not run in parallel (:confused:)
---
Deployed contract can not be modified but can be deleted (including internal state).  
---
SLEFDESTUCT opcode is invoked that has "negative gas" :question: *where is gas refined* **guessing its creator**
---
The funtionality is only available if it is programmed by author else can never be deleted.

Transaction history however remains in blockchain.
---
# Transaction are atomic.

Changes are recoreded only if all execution terminates successfully (meaning no error and reach the end).

Rolls back if fails.

Failed transactions are recoreded but ether spend on gas is deducted.

---

# Ethereum High Level Language

It is virtual machine (similar to CPU x86-64)
Bytecode are executed by EVM
Bytecode can be written in bytecode but its not friendly. *even solidity is not very friendly* :grinning: in compare to other lanague
---
# Instead, High-level language is used that is compiled to bytecode.

Any high-level langauge be converted to byte code, but would difficult because smart contract run in more constraint and minimalistic environment. So Ethereuem specific language are created.

---

There are few languages for writing smart contract in ethereum. (Solidity, Vyper)

---

# General Language Type

---
# Declarative (e.g Haskel, SQL)

Only logic but no flow
No variables
Declarative language is easier to know how program will behave (no side effects)

---

# Imperlative (e.g C++, Java)

Logic and flow
Can be used to write declarative program
Used by many developers but unlikely to bug free
---
# Hybrid
Javascript, Python, Lisp

---

# Smart Contract bug cost money :money_mouth_face: :pound:

---

So should not contain any unindented sideeffect.

And declarative paradigm is go to but widely popular langauge is solidity which is a imperlative language :confused:

---

# LLL 

- Declarative
- Lisp-**likewithout iterative flows (loops)**

---


# Serpant

- Imperlative
- Python like

---


# Solidity

- Imperlative
- Inspired by Javascript, C++, Java
- Most Popular

---


# Vyper

- New
- Python like
- Close to pure-functional

---


# Bamboo

- New
- Erlang like
- without iterative flows (loops)
- Intended to reduce side effects

---


# Solidity

Created by Dr. Gavin Wood (Co-author).

Developed by Christian Reitiwessner and then also by Alex Beregszaszi, Liana Husikyan, Yoichi Hirai, and several former Ethereum core contributors.

Use by other blockchain too. 

Now maintained as separte project.

---

# Solidity Version

Follows semantic versioning. 

*MAJOR.MINOR.PATCH*

Current Version: 0.5.2 https://github.com/ethereum/solidity/releases

---

# Install compiler - solc

Example on book Debian based

```
$ sudo add-apt-repository ppa:ethereum/ethereum
$ sudo apt update
$ sudo apt install solc
```
---

# Actually depends on operating system

https://solidity.readthedocs.io/en/v0.4.24/installing-solidity.html

For mac brew can be used

I am currenlty using docker version :sunglasses:

Text Editor / IDE

VSCode, Atom, Emac. Vim

---

# Ethereum Contract ABI

Stands for Application Binary Interface

Defines interface between two program.

---

# Example 

Mobile app know what to send and what to expect thus encode and decodes data.
ABI is JSON array that describes functions and events. Produced by compiler (solo)

Functions : `type`, `name`, `inputs`, `outputs`, `constant`, and `payable`.

Events: `type`, `name`, `inputs`, and `anonymous`
---


```
$ solc --abi Faucet.sol
======= Faucet.sol:Faucet =======
Contract JSON ABI
[{"constant":false,"inputs":[{"name":"withdraw_amount","type":"uint256"}], \
"name":"withdraw","outputs":[],"payable":false,"stateMutability":"nonpayable", \
"type":"function"},{"payable":true,"stateMutability":"payable", \
"type":"fallback"}]
```


---

# Compiler and Language

Compiler version should match langauge version otherwise it show errors and warning.

The language is on constant change so lot of breaking change can be expected.

Compiler is able to read the version and produce error, warning and suggestions.

---


# Solidity Language

---


# Data Types

---
# Boolean (bool)

Boolean value, true or false, with logical operators ! (not), && (and), || (or), == (equal), and != (not equal).

---
# Integer (int, uint)

Signed (int) and unsigned (uint) integers, declared in increments of 8 bits from int8 to uint256. Without a size suffix, 256-bit quantities are used, to match the word size of the EVM.
---
# Fixed point (fixed, ufixed)

Fixed-point numbers, declared with (`u`)`fixed*M*x*N*` where *M* is the size in bits (increments of 8 up to 256) and *N* is the number of decimals after the point (up to 18); e.g., ufixed32x2.
---
# Address

A 20-byte Ethereum address. The address object has many helpful member functions, the main ones being balance (returns the account balance) and `transfer` (transfers ether to the account).
---
# Byte array (fixed)

Fixed-size arrays of bytes, declared with bytes1 up to bytes32.
---
# Byte array (dynamic)

Variable-sized arrays of bytes, declared with bytes or string.
---
# Enum

User-defined type for enumerating discrete values: enum NAME {LABEL1, LABEL 2, ...}.
---
# Arrays
 An array of any type, either fixed or dynamic: uint32[][5] is a fixed-size array of five dynamic arrays of unsigned integers.
---
# Struct

User-defined data containers for grouping variables: `struct NAME {TYPE1 VARIABLE1; TYPE2 VARIABLE2; ...}`.
---
# Mapping

Hash lookup tables for *key* => *value* pairs: mapping(KEY_TYPE => VALUE_TYPE) NAME.
---
In addition to these data types, Solidity also offers a variety of value literals that can be used to calculate different units:
---
# Time units

The units seconds, minutes, hours, and days can be used as suffixes, converting to multiples of the base unit seconds.
---
# Ether units
The units wei, finney, szabo, and ether can be used as suffixes, converting to multiples of the base unit wei.
---
# Global Variables and Functions

Transaction/Message Context
- msg.sender
- msg.value
- msg.gas - This was deprecated in Solidity v0.4.21
- msg.data
- msg.sig
---
# Transaction Context
- tx.gasprice
- tx.origin
---
# Block Context
- block.blockhash(__blockNumber__)
- block.coinbase
- block.difficulty
- block.gaslimit
- block.number
- block.timestamp
---
# Address Object
- address.balance
- address.transfer(__amount__)
- address.send(__amount__)
- address.call(__payload__)
- address.callcode(__payload__)
- address.delegatecall()
---
# Built-in functions
- addmod, mulmod - For example, addmod(x,y,k) calculates (x + y) % k.
- keccak256, sha256, sha3, ripemd160
- ecrecover
- selfdestrunct(__recipient_address__)
- this
---
# Contract Definition
- interface
- library
---
# Functions
- FunctionName
- *parameters*
---
# Visibility (invokability)
- public
- external
- internal
- private
---
# Behaviour
- constant or view
- pure
- payable
---
export default CodeSlate

<CodeSurfer 
  code={`pragma solidity ^0.4.22;
contract Faucet {
	 address owner;
	
	constructor() {
		owner = msg.sender;
	}
	
	modifier onlyOwner {
        require(msg.sender == owner);
        _;
    }
    
	function destroy() public onlyOwner {
        require(msg.sender == owner);
        selfdestruct(owner);
    }
} `}
  title="Contract - Contructor and Destructor"
/>
---
export default CodeSlate

<CodeSurfer
  title="Contract Inheritance"
  code={`contract Dog is Animal {
  ...
}
   
// multiple inheriance
contract Lion is Animal, Cat {
  ...
}`}
/>
---
export default CodeSlate

<CodeSurfer
  code={require('raw-loader!./snippets/2.contractexample.sol')}
  title="Example"
/>

---
# Error Handling
---
# assert, require, revert
- throw is deprecated
- All state are reverted when error occurs

```java
require(msg.sender == owner);
//  v0.4.22
require(msg.sender == owner, "Only the contract owner can call this function");

require(this.balance >= withdraw_amount,
	"Insufficient balance in faucet for withdrawal request");
msg.sender.transfer(withdraw_amount);
```
---
# Events
- *Transaction receipt* is generated for all.
- Logs entries to defined events
- Web3.js library provide data structure to contains transactions logs
---
export default CodeSlate

<CodeSurfer
  title="Example"
  code={require("raw-loader!./snippets/3.events.sol")}
/>
---
# Truffle
It is set of tool to develop dapp application. https://www.truffleframework.com/
---
export default CodeSlate

<CodeSurfer
  title="Bash"
  code={require("raw-loader!./snippets/bashoutput.sh")}
/>
---
export default CodeSlate

<CodeSurfer
  title="Calling other contracts"
  code={require("raw-loader!./snippets/callingexternalcontract.sol")}
  showNumbers
  steps={[
    { lines: [], notes: "Examples for calling contracts" },
    { range: [1, 11], notes:"Create new instance of contract" },
    { range: [13, 24], notes:"Addressing existing instance" },
    { range: [26, 31], notes:"Delegate call" },
    { range: [31, 40], notes:"Error Handling" },
    { lines: [] },
  ]}
/>
---
# Gas Considerations
---
# Avoid Dynamically Sized Arrays
---
# Avoid Calls to Other Contracts
---
# Estimating Gas Cost
---
export default CodeSlate

<CodeSurfer
  title="Gas Estimating"
  code={require("raw-loader!./snippets/estimategas.js")}
/>
# Questions
---
# Thank you !
